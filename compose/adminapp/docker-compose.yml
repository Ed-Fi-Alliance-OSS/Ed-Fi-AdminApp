name: edfiadminapp-local-build

services:
  edfiadminapp-api:
    build:
      context: ../../
      dockerfile: compose/adminapp/Dockerfile.api
    container_name: edfiadminapp-api
    # Remove or comment out the ports since nginx will proxy to it
    # ports:
    #   - "127.0.0.1:3333:3333"
    volumes:
      - api-logs:/app/logs
      - ../../compose/ssl/server.crt:/app/ssl/server.crt:ro
    environment:
      - NODE_EXTRA_CA_CERTS=/app/ssl/server.crt
    extra_hosts:
      - 'localhost:host-gateway' # Allow container to access host's localhost
    external_links:
      - edfiadminapp-db:edfiadminapp-db
    restart: unless-stopped
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:3333/api/healthcheck || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    networks:
      - edfiadminapp-network

  edfiadminapp-fe:
    build:
      context: ../../
      dockerfile: compose/adminapp/Dockerfile.fe
      args:
        # Change this to use the nginx proxy URL
        VITE_API_URL: '${VITE_API_URL:-https://localhost/adminapp-api}'
        VITE_OIDC_ID: ${VITE_OIDC_ID:-1}
        VITE_BASE_PATH: '${VITE_BASE_PATH:-/adminapp/}'
        VITE_HELP_GUIDE: '${VITE_HELP_GUIDE:-https://docs.ed-fi.org/}'
        VITE_IDP_ACCOUNT_URL: '${VITE_IDP_ACCOUNT_URL:-https://localhost/auth/realms/edfi/account/}'
        VITE_STARTING_GUIDE: '${VITE_STARTING_GUIDE:-https://docs.ed-fi.org/reference/admin-app-v4/system-administrators/global-administration-tasks}'
        VITE_CONTACT: '${VITE_CONTACT:-https://community.ed-fi.org/}'
    container_name: edfiadminapp-fe
    # Remove or comment out the ports since nginx will proxy to it
    # ports:
    #   - "127.0.0.1:4200:4200"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      edfiadminapp-api:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:4200/health || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - edfiadminapp-network

networks:
  edfiadminapp-network:
    external: true
    name: edfiadminapp-network

volumes:
  api-logs:
    driver: local
    name: vol-edfiadminapp-api-logs
