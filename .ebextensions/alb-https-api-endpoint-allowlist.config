Resources:
  # Allow only the EA office IP to /api and check for host match
  ApiAllowRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn:
        Ref: AWSEBV2LoadBalancerListener443
      Priority: 1
      Conditions:
        # Check if /api request
        - Field: path-pattern
          PathPatternConfig:
            Values:
              - /api
        # Check if EA Office IP
        - Field: source-ip
          SourceIpConfig:
            Values:
              - 172.102.6.120/29
        # Check if host matches
        - Field: host-header
          HostHeaderConfig:
            Values:
              - Fn::Join:
                  - ''
                  - - '{{resolve:ssm:/beanstalk/environments/'
                    - Ref: 'AWSEBEnvironmentName'
                    - '/parameters/ALBHostNameRestriction}}'
      Actions:
        - Type: forward
          TargetGroupArn:
            Ref: https
  # Allow only the EA office IP to /api/ and check for host match
  ApiSlashAllowRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn:
        Ref: AWSEBV2LoadBalancerListener443
      Priority: 2
      Conditions:
        # Check if /api request
        - Field: path-pattern
          PathPatternConfig:
            Values:
              - /api/
        # Check if EA Office IP
        - Field: source-ip
          SourceIpConfig:
            Values:
              - 172.102.6.120/29
        # Check if host matches
        - Field: host-header
          HostHeaderConfig:
            Values:
              - Fn::Join:
                  - ''
                  - - '{{resolve:ssm:/beanstalk/environments/'
                    - Ref: 'AWSEBEnvironmentName'
                    - '/parameters/ALBHostNameRestriction}}'
      Actions:
        - Type: forward
          TargetGroupArn:
            Ref: https

  # Deny all other /api traffic
  ApiDenyRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn:
        Ref: AWSEBV2LoadBalancerListener443
      Priority: 3
      Conditions:
        - Field: path-pattern
          PathPatternConfig:
            Values:
              - /api
      Actions:
        - Type: fixed-response
          FixedResponseConfig:
            ContentType: 'application/json'
            MessageBody: '{ "message": "Forbidden" }'
            StatusCode: '403'

  # Deny all other /api/ traffic
  ApiSlashDenyRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn:
        Ref: AWSEBV2LoadBalancerListener443
      Priority: 4
      Conditions:
        - Field: path-pattern
          PathPatternConfig:
            Values:
              - /api/
      Actions:
        - Type: fixed-response
          FixedResponseConfig:
            ContentType: 'application/json'
            MessageBody: '{ "message": "Forbidden" }'
            StatusCode: '403'